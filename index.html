<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>挂机修仙 · 玄门 V2.0.5</title>
    <link rel="stylesheet" href="style.css?v=2.35">
</head>
<body>
    <div id="global-tooltip" class="tooltip-box-fixed"></div>
    <!-- 0. 登录界面 -->
    <div id="login-screen">
        <div class="login-box">
            <h2>修仙 · 玄门 <small id="build-tag" style="font-size: 0.5em; color: #666;">V2.0.5</small></h2>
            <input type="text" id="username" placeholder="道号">
            <input type="password" id="password" placeholder="密语 (任意)">
            <div class="login-options">
                <label><input type="checkbox" id="remember-me" checked> 记住道号</label>
                <a href="#" id="link-release-notes" style="font-size:0.9em; color:#aaa; text-decoration:none;">📢 内测公告</a>
            </div>
            <button id="btn-login">踏入仙途</button>
        </div>
    </div>

    <!-- 主界面 -->
    <div id="app" class="hidden">
        <div class="main-layout">
            <!-- 1. 左侧信息面板 -->
            <aside id="left-panel" class="left-panel panel">
                <div class="panel-header">
                    <h3>修士信息</h3>
                    <button id="btn-collapse-panel" class="btn-icon" title="折叠面板">◀</button>
                </div>
                <div class="scroll-content">
                    <!-- 基础属性网格 (JS动态渲染) -->
                    <div id="stats-grid-container"></div>
                    
                    <div class="divider"></div>
                    
                    <h3>道统亲和</h3>
                    <ul id="affinity-list" class="affinity-list">
                        <!-- JS 生成 -->
                    </ul>

                    <div class="divider"></div>

                    <h3>装备</h3>
                    <div class="equipment-grid">
                        <div class="equip-slot empty" data-slot="head" title="头部"><span class="slot-icon">⛑</span></div>
                        <div class="equip-slot empty" data-slot="body" title="身躯"><span class="slot-icon">🧥</span></div>
                        <div class="equip-slot empty" data-slot="weapon" title="武器"><span class="slot-icon">🗡</span></div>
                        <div class="equip-slot empty" data-slot="artifact" title="法宝"><span class="slot-icon">🔮</span></div>
                    </div>
                    
                    <div class="divider"></div>

                    <h3>储物袋</h3>
                    <div class="item-grid" id="mini-inventory">
                        <div class="item-slot" title="空置"></div>
                        <div class="item-slot" title="空置"></div>
                        <div class="item-slot" title="空置"></div>
                        <div class="item-slot" title="空置"></div>
                        <div class="item-slot" title="空置"></div>
                        <div class="item-slot" title="空置"></div>
                        <div class="item-slot" title="空置"></div>
                        <div class="item-slot" title="空置"></div>
                        <div class="item-slot" title="空置"></div>
                        <div class="item-slot" title="空置"></div>
                    </div>

                    <div class="divider"></div>

                    <h3>快捷操作</h3>
                    <div class="action-buttons">
                        <button id="btn-quick-lineage">道法置换</button>
                        <button id="btn-quick-inventory">符箓使用</button>
                    </div>

                    <div class="divider"></div>
                    <div class="settings-group">
                         <label><input type="checkbox" id="pause-on-event" checked> 遇事暂停挂机</label>
                         <button id="btn-view-release-notes" class="btn-mini" style="margin-top:6px; width:100%;">📄 查看更新公告</button>
                         <button id="btn-theme-toggle" class="btn-mini" style="margin-top:6px; width:100%;">切换主题 (默认/摸鱼)</button>
                         <button id="btn-stats-modifier" class="btn-mini" style="margin-top:6px; width:100%; background: #9b59b6; border-color: #8e44ad; color: white;">🛠️ 数值修改器</button>
                         <label id="debug-meta-row" title="显示详细的调试元数据" style="display:none;"><input type="checkbox" id="debug-meta-toggle"> 显示调试元数据</label>
                    </div>

                    <div class="divider"></div>
                    <details id="debug-panel" class="debug-panel" style="display:none;">
                        <summary>调试面板</summary>
                        <div class="debug-panel-body">
                            <!-- Admin Controls -->
                            <div id="admin-controls" class="debug-section" style="border-bottom:1px solid #444; margin-bottom:8px; padding-bottom:8px; display:none;">
                                <div class="debug-row">
                                    <span class="badge" style="background:#e74c3c; color:white;">ADMIN</span>
                                    <span style="font-size:0.8em; color:#aaa;">特权操作</span>
                                    <button id="admin-auth-device" class="btn-mini" style="margin-left:auto;" title="授权此浏览器永久开启管理员模式">授权此设备</button>
                                </div>
                                <div class="debug-row">
                                    <input id="admin-event-id" type="text" placeholder="Event ID" style="width:40%;">
                                    <button id="admin-trigger-event" class="btn-mini" style="width:25%;">触发</button>
                                    <button id="admin-force-complete" class="btn-mini" style="width:30%;">强制完成</button>
                                </div>
                                <div class="debug-row">
                                    <input id="admin-flag-key" type="text" placeholder="Flag Key" style="width:40%;">
                                    <input id="admin-flag-val" type="text" placeholder="Value (true/123/str)" style="width:40%;">
                                    <button id="admin-set-flag" class="btn-mini" style="width:15%;">Set</button>
                                </div>
                                <div class="debug-row">
                                    <button id="admin-backup-save" class="btn-mini">复制存档(Base64)</button>
                                    <button id="admin-restore-save" class="btn-mini">导入存档</button>
                                </div>
                            </div>

                            <div class="debug-row" style="display:flex; gap:6px; margin-bottom:6px;">
                                <button id="debug-tab-meta" class="btn-mini" style="flex:1;">Meta</button>
                                <button id="debug-tab-replay" class="btn-mini" style="flex:1;">Replay</button>
                            </div>

                            <div id="debug-panel-meta">
                                <div class="debug-row">
                                    <span class="debug-label">战斗引擎</span>
                                    <select id="debug-engine-select"></select>
                                    <button id="debug-engine-apply" class="btn-mini">切换</button>
                                </div>
                                <div class="debug-row">
                                    <label class="debug-label"><input type="checkbox" id="debug-replay-toggle"> 录制 replay</label>
                                    <button id="debug-replay-clear" class="btn-mini">清空</button>
                                </div>
                                <div class="debug-row">
                                    <span class="debug-label">RulesConfig</span>
                                    <button id="debug-rules-apply" class="btn-mini">应用</button>
                                </div>
                                <textarea id="debug-rules-config" class="debug-textarea" rows="6"></textarea>
                                <pre id="debug-last-meta" class="debug-pre"></pre>
                            </div>

                            <div id="debug-panel-replay" style="display:none;">
                                <div class="debug-row">
                                    <button id="debug-replay-play" class="btn-mini">▶ Play</button>
                                    <button id="debug-replay-pause" class="btn-mini">⏸ Pause</button>
                                    <button id="debug-replay-step-back" class="btn-mini">⏮ Step</button>
                                    <button id="debug-replay-step-fwd" class="btn-mini">⏭ Step</button>
                                </div>
                                <div class="debug-row" style="display:flex; align-items:center; gap:6px;">
                                    <span class="debug-label" style="min-width:56px;">Engine A</span>
                                    <select id="debug-replay-engine-a" style="flex:1;"></select>
                                </div>
                                <div class="debug-row" style="display:flex; align-items:center; gap:6px;">
                                    <span class="debug-label" style="min-width:56px;">Engine B</span>
                                    <select id="debug-replay-engine-b" style="flex:1;"></select>
                                </div>
                                <div class="debug-row">
                                    <button id="debug-replay-shadow-run" class="btn-mini">对拍 A/B</button>
                                </div>
                                <div class="debug-row" style="display:flex; align-items:center; gap:8px;">
                                    <span class="debug-label" style="min-width:42px;">Tick</span>
                                    <input id="debug-replay-tick" type="range" min="0" max="0" value="0" style="flex:1;">
                                    <span id="debug-replay-tick-label" style="min-width:56px; text-align:right;">0</span>
                                </div>
                                <div class="debug-row">
                                    <button id="debug-replay-rebuild" class="btn-mini">重建时间轴</button>
                                    <button id="debug-replay-adopt-baseline" class="btn-mini">采用当前为基线</button>
                                </div>
                                <pre id="debug-replay-actions" class="debug-pre" data-role="replay-actions"></pre>
                                <pre id="debug-replay-logs" class="debug-pre" data-role="replay-logs"></pre>
                                <pre id="debug-replay-issues" class="debug-pre" data-role="replay-issues"></pre>
                            </div>
                        </div>
                    </details>
                    <div class="divider"></div>
                    <h3>系统设置</h3>
                    <div class="action-buttons">
                        <button id="btn-save">手动存档</button>
                        <button id="btn-logout" class="btn-warn">退出登录</button>
                        <button id="btn-test-v17" class="btn-large" style="margin-top: 5px; background: #8e44ad; border-color: #8e44ad; display:none;">测试 V1.7 多怪战斗</button>
                        <button id="btn-reset-save" class="btn-danger" title="清除当前存档并重置">兵解重修</button>
                    </div>
                </div>
            </aside>
            <!-- 折叠后的展开按钮 -->
            <button id="expand-btn" class="hidden btn-float">▶</button>

            <!-- 2. 中心地图区 (核心挂机) -->
            <main class="center-panel">
                <div class="center-topbar" style="display:none;">
                    <div class="center-tabs" role="tablist" aria-label="中心视图切换">
                        <button id="center-tab-map" class="center-tab active" role="tab" aria-selected="true" aria-controls="view-map">地图</button>
                        <button id="center-tab-battle" class="center-tab" role="tab" aria-selected="false" aria-controls="view-battle">战斗</button>
                    </div>
                </div>
                <!-- 视图容器 -->
                <div id="view-map" class="view-content active">
                    <div class="panel map-selection">
                        <h3>地图选择 <span id="map-hint" class="hint-text">(请选择一处挂机)</span></h3>
                        <div id="map-list" class="map-grid">
                            <!-- JS 生成地图按钮 -->
                        </div>
                    </div>
                    
                    <div id="active-map-panel" class="panel active-map hidden">
                        <div class="map-header">
                            <h2 id="current-map-name">未选择</h2>
                            <span id="hang-status-badge" class="badge">空闲</span>
                        </div>
                        <div class="map-details">
                            <p><strong>怪物：</strong><span id="map-monsters">--</span></p>
                            <p><strong>掉落：</strong><span id="map-drops">--</span></p>
                        </div>
                        <div class="map-controls">
                            <button id="btn-toggle-hang" class="btn-large">开始挂机</button>
                        </div>
                    </div>
                </div>

                <div id="view-battle" class="view-content">
                    <div class="panel battle-panel">
                        <div class="battle-panel-header">
                            <h3 style="margin:0;">战斗概览</h3>
                            <span id="battle-env" class="badge" style="margin-left:auto;">未在战斗</span>
                        </div>
                        <div id="battle-overview-empty" class="battle-empty">当前未进入战斗，切回地图继续挂机。</div>
                        <div id="battle-overview" class="battle-overview hidden">
                            <div class="battle-overview-grid">
                                <div class="battle-section battle-side">
                                    <div class="battle-section-title">你</div>
                                    <div class="battle-bars">
                                        <div class="battle-bar">
                                            <div class="battle-bar-label">气血</div>
                                            <div class="battle-bar-track"><div id="battle-player-hp-fill" class="battle-bar-fill hp"></div></div>
                                            <div id="battle-player-hp-text" class="battle-bar-text">--/--</div>
                                        </div>
                                        <div class="battle-bar">
                                            <div class="battle-bar-label">灵力</div>
                                            <div class="battle-bar-track"><div id="battle-player-mp-fill" class="battle-bar-fill mp"></div></div>
                                            <div id="battle-player-mp-text" class="battle-bar-text">--/--</div>
                                        </div>
                                    </div>
                                    <div id="battle-player-status" class="battle-status"></div>
                                </div>

                                <div class="battle-section battle-side">
                                    <div class="battle-section-title">敌</div>
                                    <div id="battle-monsters" class="battle-monsters"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-inventory" class="view-content">
                    <div class="panel">
                        <h3>符箓背包</h3>
                        <div id="inventory-list" class="item-grid">
                            <!-- JS 生成 -->
                        </div>
                    </div>
                </div>

                <div id="view-lineage" class="view-content">
                    <div class="panel">
                        <h3>道统借法</h3>
                        <div id="known-lineages"></div>
                        <h4>可用借法残响</h4>
                        <ul id="passive-skills"></ul>
                    </div>
                </div>
            </main>

            <!-- 3. 右侧战斗/日志区 -->
            <aside class="right-panel panel">
                <div class="log-header">
                    <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                        <h3>行动日志</h3>
                        <button id="btn-toggle-log" class="btn-icon" title="折叠/展开日志">▼</button>
                    </div>
                    <button id="btn-export-battle" class="btn-icon" title="导出本场战斗 JSON" style="display:none;">⤓</button>
                    <div id="log-filters" class="log-filters">
                        <button class="log-filter active" data-filter="all">全部</button>
                        <button class="log-filter" data-filter="battle">战斗</button>
                        <button class="log-filter" data-filter="drop">掉落</button>
                        <button class="log-filter" data-filter="env">环境</button>
                        <button class="log-filter" data-filter="npc">NPC</button>
                        <button class="log-filter" data-filter="sys">系统</button>
                    </div>
                </div>
                <div id="log-container" class="log-container">
                    <div id="combat-fx-layer" class="combat-fx-layer"></div>
                    <!-- JS 滚动生成日志 -->
                </div>
            </aside>
        </div>

        <!-- 4. 底部导航栏 -->
        <nav class="bottom-nav">
            <button id="nav-map" class="nav-btn active">地图</button>
            <button id="nav-battle" class="nav-btn">战斗</button>
            <button id="nav-inventory" class="nav-btn">背包</button>
            <button id="nav-lineage" class="nav-btn">借法</button>
            <button id="nav-talisman-guide" class="nav-btn">符箓图鉴</button>
            <button id="nav-trigger-event" class="nav-btn">触发事件(测)</button>
        </nav>
    </div>

    <!-- 5. 弹窗系统 -->
    <div id="event-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="event-title">突发事件</h3>
            <p id="event-desc">事件描述文本...</p>
            <div id="event-options" class="button-group">
                <!-- JS 生成选项 -->
            </div>
        </div>
    </div>

    <!-- 5. 公告弹窗 (V1.9 新增) -->
    <div id="release-note-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
            <h3 style="border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 10px;">内测更新公告</h3>
            <div id="release-note-body" class="scroll-content" style="flex: 1; overflow-y: auto; text-align: left; padding-right: 5px;">
                <!-- JS 填充内容 -->
            </div>
            <div class="modal-actions" style="margin-top: 15px; text-align: right;">
                <button id="btn-close-release-note">关闭</button>
            </div>
        </div>
    </div>

    <!-- 6. 符箓图鉴弹窗 -->
    <div id="talisman-guide-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 700px; max-height: 85vh; display: flex; flex-direction: column;">
            <h3 style="border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 10px;">符箓图鉴</h3>
            <div id="talisman-guide-body" class="scroll-content" style="flex: 1; overflow-y: auto; text-align: left; padding-right: 5px;">
                <!-- JS 填充内容 -->
            </div>
            <div class="modal-actions" style="margin-top: 15px; text-align: right;">
                <button id="btn-close-talisman-guide">关闭</button>
            </div>
        </div>
    </div>

    <!-- 7. 数值修改器弹窗 -->
    <div id="stats-modifier-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 400px;">
            <h3 style="border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px;">数值修改器</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left; margin-bottom: 15px;">
                <div>
                    <label style="display:block; font-size:0.9em; margin-bottom:4px; color:#aaa;">气血上限 (MaxHP)</label>
                    <input type="number" id="mod-max-hp" style="width: 100%; padding: 6px; border:1px solid #555; background:#222; color:#eee; border-radius:4px;">
                </div>
                <div>
                    <label style="display:block; font-size:0.9em; margin-bottom:4px; color:#aaa;">灵力上限 (MaxMP)</label>
                    <input type="number" id="mod-max-mp" style="width: 100%; padding: 6px; border:1px solid #555; background:#222; color:#eee; border-radius:4px;">
                </div>
                <div>
                    <label style="display:block; font-size:0.9em; margin-bottom:4px; color:#aaa;">攻击力 (Atk)</label>
                    <input type="number" id="mod-atk" style="width: 100%; padding: 6px; border:1px solid #555; background:#222; color:#eee; border-radius:4px;">
                </div>
                 <div>
                    <label style="display:block; font-size:0.9em; margin-bottom:4px; color:#aaa;">法术强度 (MAtk)</label>
                    <input type="number" id="mod-matk" style="width: 100%; padding: 6px; border:1px solid #555; background:#222; color:#eee; border-radius:4px;">
                </div>
                <div>
                    <label style="display:block; font-size:0.9em; margin-bottom:4px; color:#aaa;">速度 (Speed)</label>
                    <input type="number" id="mod-speed" style="width: 100%; padding: 6px; border:1px solid #555; background:#222; color:#eee; border-radius:4px;">
                </div>
            </div>

            <div class="modal-actions" style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #444; padding-top: 15px;">
                <button id="btn-mod-reset" style="background: #7f8c8d; padding: 6px 12px; font-size: 0.9em;">↺ 重置为标准</button>
                <div style="display: flex; gap: 8px;">
                    <button id="btn-mod-apply" style="background: #e74c3c; padding: 6px 15px;">应用修改</button>
                    <button id="btn-mod-close" style="padding: 6px 12px;">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 
        V2 架构脚本加载顺序 (Critical for dependencies):
        1. data.js - 静态配置 (无依赖)
        2. state.js - 全局状态 gameState/EventSystem/HeartDemonSystem (无依赖或仅Data)
        3. combat_engine.js - 纯函数战斗引擎 (无依赖)
        4. logic.js - 核心逻辑 Rules (依赖 State, Data, Combat)
        5. ui.js - 视图渲染 (依赖 State, Data, Logic)
        6. main.js - 控制器/入口 (依赖 UI, Logic, State)
    -->
    <script src="js/data.js?v=2.37"></script>
    <script src="js/data_skills_common.js?v=2.37"></script>
    <script src="js/data_skills_ghost.js?v=2.37"></script>
    <script src="js/data_skills_yinyang.js?v=2.37"></script>
    <script src="js/data_skills_qiankun.js?v=2.37"></script>
    <script src="js/data_skills_tianyi.js?v=2.37"></script>
    <script src="js/state.js?v=2.37"></script>
    <script src="js/combat_engine.js?v=2.37"></script>
    <script src="js/logic.js?v=2.37"></script>
    <script src="js/ui.js?v=2.37"></script>
    <script src="js/main.js?v=2.37"></script>
    
    <script>
        window.__FREEZE_TAG__ = 'V2.0.0-internal-alpha';
        if (typeof window.__PLAYER_MODE__ === 'undefined') window.__PLAYER_MODE__ = true;

        // 初始化调试开关
        document.addEventListener('DOMContentLoaded', () => {
            const applyPlayerMode = () => {
                // Admin Account Check: Username 'Admin'/'Dev' or localStorage flag
                const isAdmin = (typeof gameState !== 'undefined' && (gameState.username === 'Admin' || gameState.username === 'Dev')) || 
                                (typeof localStorage !== 'undefined' && localStorage.getItem('xiuxian_admin_mode') === 'true');
                
                if (isAdmin) {
                    window.__PLAYER_MODE__ = false; // Auto-enable Dev Mode for Admin
                    if (typeof UI !== 'undefined') UI.addLog("[System] Admin privileges active.", "sys");
                }

                const isPlayer = (typeof window !== 'undefined' && window.__PLAYER_MODE__ === true);
                const debugPanel = document.getElementById('debug-panel');
                const debugMetaRow = document.getElementById('debug-meta-row');
                const btnTest = document.getElementById('btn-test-v17');
                const adminControls = document.getElementById('admin-controls');
                // btnToggleDev removed

                if (debugPanel) debugPanel.style.display = 'none';
                if (debugMetaRow) debugMetaRow.style.display = 'none';
                if (btnTest) btnTest.style.display = 'none';
                if (adminControls) adminControls.style.display = isAdmin ? '' : 'none';
                // btnToggleDev display logic removed
            };

            // Admin Logic Initialization
            const initAdminControls = () => {
                const btnAuth = document.getElementById('admin-auth-device');
                if (btnAuth) {
                    btnAuth.addEventListener('click', () => {
                        if (confirm("确定授权此浏览器永久开启管理员模式？")) {
                            localStorage.setItem('xiuxian_admin_mode', 'true');
                            alert("已授权。以后无论登录哪个账号，都将拥有管理员权限。");
                            applyPlayerMode();
                        }
                    });
                }

                const btnTrigger = document.getElementById('admin-trigger-event');
                if (btnTrigger) {
                    btnTrigger.addEventListener('click', () => {
                        const id = document.getElementById('admin-event-id').value;
                        if (id && typeof gameState !== 'undefined') {
                            gameState.applyStoryUpdate({ nextEventId: id, nextAtTick: gameState.story.tick, delayTicks: 0 });
                            if (typeof UI !== 'undefined') UI.addLog(`[Admin] Scheduled event: ${id}`, 'sys');
                        }
                    });
                }

                const btnForceComplete = document.getElementById('admin-force-complete');
                if (btnForceComplete) {
                    btnForceComplete.addEventListener('click', () => {
                        if (typeof gameState !== 'undefined') {
                            gameState.applyStoryUpdate({ complete: true });
                            if (typeof UI !== 'undefined') UI.addLog("[Admin] Force completed current event.", "sys");
                        }
                    });
                }

                const btnSetFlag = document.getElementById('admin-set-flag');
                if (btnSetFlag) {
                    btnSetFlag.addEventListener('click', () => {
                        const key = document.getElementById('admin-flag-key').value;
                        let val = document.getElementById('admin-flag-val').value;
                        if (key && typeof gameState !== 'undefined') {
                            if (val === 'true') val = true;
                            else if (val === 'false') val = false;
                            else if (!isNaN(Number(val))) val = Number(val);
                            
                            gameState.applyStoryUpdate({ setFlags: { [key]: val } });
                            if (typeof UI !== 'undefined') UI.addLog(`[Admin] Set flag ${key} = ${val}`, 'sys');
                        }
                    });
                }

                const btnBackup = document.getElementById('admin-backup-save');
                if (btnBackup) {
                    btnBackup.addEventListener('click', () => {
                        if (typeof gameState !== 'undefined') {
                            gameState.save(); 
                            const key = `cultivation_save_${gameState.username}`;
                            const data = localStorage.getItem(key);
                            if (data) {
                                const b64 = btoa(unescape(encodeURIComponent(data)));
                                navigator.clipboard.writeText(b64).then(() => {
                                    alert("存档已复制到剪贴板 (Base64)");
                                }).catch(err => {
                                    console.error('Copy failed', err);
                                    alert("复制失败，请查看控制台");
                                });
                            }
                        }
                    });
                }
                
                const btnRestore = document.getElementById('admin-restore-save');
                if (btnRestore) {
                    btnRestore.addEventListener('click', () => {
                        const b64 = prompt("请输入Base64存档字符串 (将覆盖当前用户存档):");
                        if (b64) {
                            try {
                                const json = decodeURIComponent(escape(atob(b64)));
                                const data = JSON.parse(json);
                                if (data && data.username) {
                                    localStorage.setItem(`cultivation_save_${data.username}`, json);
                                    alert(`存档已导入: ${data.username}。请刷新页面并登录。`);
                                    location.reload();
                                }
                            } catch (e) {
                                alert("存档格式无效！");
                            }
                        }
                    });
                }
            };
            initAdminControls();
            
            window.applyPlayerMode = applyPlayerMode;

            const dbg = document.getElementById('debug-meta-toggle');
            if (dbg) {
                // 默认开启如果已有标记
                if (typeof window !== 'undefined' && window.DEBUG_META) {
                    dbg.checked = true;
                }
                dbg.addEventListener('change', (e) => {
                    window.DEBUG_META = e.target.checked;
                    console.log("[System] Debug Meta set to:", window.DEBUG_META);
                    // 刷新当前日志视图
                    if (typeof UI !== 'undefined' && UI.applyLogFilter) {
                        UI.applyLogFilter();
                    }
                });
            }
            
            // btnToggleDev listener removed
            
            const originalLogin = document.getElementById('btn-login');
            if (originalLogin) {
                originalLogin.addEventListener('click', () => {
                    setTimeout(applyPlayerMode, 500); 
                });
            }
            
            applyPlayerMode();
        });

        // V1.7 测试脚本
        document.getElementById('btn-test-v17').addEventListener('click', () => {
            if (!gameState.username) {
                alert("请先登录！");
                return;
            }
            if (gameState.isHanging) {
                Logic.requestStopHanging();
            }
            
            const testMonsters = [
                { name: "测试木桩(甲)", hp: 500, maxHp: 500, atk: 5, dangerLevel: 1 },
                { name: "测试木桩(乙)", hp: 300, maxHp: 300, atk: 3, dangerLevel: 0.5 },
                { name: "精英木桩", hp: 800, maxHp: 800, atk: 8, dangerLevel: 2 }
            ];
            
            // 强制进入战斗状态
            gameState.enterCombat(testMonsters);
            
            // 关键修复：手动触发 battle_start 日志以初始化 UI 折叠容器
            // 否则后续战斗日志因找不到容器而被丢弃
            const label = testMonsters.map(m => m.name).join('、');
            UI.renderCombatLogs([{ type: 'battle_start', text: `[测试] 遭遇【${label}】`, monsters: testMonsters }]);
            
            // 切换到战斗日志标签
            if (typeof UI !== 'undefined' && UI.setLogFilter) {
                UI.setLogFilter('battle');
            }

            // 开始挂机循环
            Logic.requestStartHanging();
            
            alert("已启动 V1.7 多怪战斗测试！\n请观察右侧战斗日志和怪物列表。");
        });
    </script>
</body>
</html>
